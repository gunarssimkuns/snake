(()=>{"use strict";function t(t=0){return t*Math.PI/180}const e=Array.from({length:8}).map(((e,s)=>{const i=90*s-360;return[i,Math.round(Math.sin(t(i)))]})).reduce(((t,[e,s])=>(t[e]=s,t)),{});function s(t){return e[t%360]}const i=Array.from({length:8}).map(((e,s)=>{const i=90*s-360;return[i,Math.round(Math.cos(t(i)))]})).reduce(((t,[e,s])=>(t[e]=s,t)),{});function n(t){return i[t%360]}class a{constructor(){this.body=[]}static generate(t){const{length:e,direction:i=0,head:a={x:0,y:0}}=t;return Array.from({length:e}).map(((t,e)=>({x:a.x+e*n(i),y:a.y+e*s(i)})))}}class o{constructor(t=24,e=24){this.width=t,this.height=e,this.data=Array.from({length:t*e}).map(((s,i)=>i%t==0||i%t==t-1||0==~~(i/t)||~~(i/t)==e-1?1:0)),this.info={0:"ground",1:"wall"}}}class r{constructor(){this.el=document.createElement("span"),this.el.classList.toggle("score",!0),document.body.appendChild(this.el),this.reset()}update(t){this.value=t,this.el.innerHTML=this.value}reset(){this.update(0)}}class h{constructor(t){const{width:e,height:s,x:i=0,y:n=0,scale:a=32}=t;this.x=i,this.y=n,this.scale=a,this.el=document.createElement("canvas"),this.context=this.el.getContext("2d"),this._angle=0,this.angle=0,this.resize(e,s)}resize(t,e){this.width=t,this.height=e,this.el.width=t,this.el.height=e,this.diagonal=function(t=0,e=0){return Math.floor(Math.sqrt(t**2+e**2))}(t,e)}moveTo(t,e){this.x=t,this.y=e}scrollTo(t,e){this.x+=.05*(t-this.x),this.y+=.05*(e-this.y)}clear(t="rgba(0, 0, 0, 0)"){const e=this.context;e.imageSmoothingEnabled=!1,e.save(),e.fillStyle=t,e.fillRect(0,0,this.width,this.height),e.restore()}createBufferContext(e,s,i){const n=this,a=document.createElement("canvas");a.width=e,a.height=s;const o=a.getContext("2d");return{updateBuffer(){o.save(),o.clearRect(0,0,a.width,a.height),o.scale(n.scale,n.scale),i(o),o.restore()},drawFromBuffer(){const e=n.context;e.save(),e.translate(~~(.5*n.width),~~(.5*n.height)),e.rotate(t(n.angle+n._angle)),e.translate(~~(-n.x-.5*n.scale),~~(-n.y-.5*n.scale)),e.drawImage(a,0,0,a.width,a.height),e.restore()}}}}const d=[{void:"#1f306e",ground:"#553772",wall:"#8f3b76",snake:"#c7417b",food:"#f5487f"},{void:"#343090",ground:"#5f59f7",wall:"#8c61ff",snake:"#6592fd",food:"#44c2fd"},{void:"#e74645",ground:"#fb7756",wall:"#1ac0c6",snake:"#facd60",food:"#fdfa66"},{void:"#E3D26F",ground:"#CA895F",wall:"#A15E49",snake:"#4E3822",food:"#2F1B25"}];let c,l,u=[{x:12,y:4}],p=[];const w=t=>t(),f=new class{constructor(){this.score=new r,this.snake=new a,this.map=new o,this.viewport=new h({width:document.documentElement.clientWidth,height:document.documentElement.clientHeight,scale:document.documentElement.clientWidth<768?24:32}),this.init()}reset(){c=Math.floor(Math.random()*d.length),l=90,p=[],this.viewport._angle=this.viewport.angle,this.viewport.angle=0,this.snake.body=a.generate({length:5,direction:l,head:{x:~~(.5*this.map.width),y:~~(.5*this.map.height)}}),this.score.reset()}init(){document.body.appendChild(this.viewport.el),this.reset(),this.renderFns=[],this.renderFns.push((()=>{this.viewport.scrollTo(this.snake.body[0].x*this.viewport.scale,this.snake.body[0].y*this.viewport.scale),this.viewport._angle=this.viewport._angle-.1*this.viewport._angle}));const t=this.viewport.createBufferContext(this.map.width*this.viewport.scale,this.map.height*this.viewport.scale,(t=>{this.map.data.forEach(((e,s)=>{const i=this.map.info[e];t.fillStyle=d[c][i],t.fillRect(s%this.map.width,~~(s/this.map.width),1,1)}))}));t.updateBuffer(),this.renderFns.push(t.drawFromBuffer);const e=this.viewport.createBufferContext(this.map.width*this.viewport.scale,this.map.height*this.viewport.scale,(t=>{t.fillStyle=d[c].snake;for(let e=0;e<this.snake.body.length;e++)t.fillRect(this.snake.body[e].x,this.snake.body[e].y,1,1)}));e.updateBuffer(),this.renderFns.push(e.drawFromBuffer);const i=this.viewport.createBufferContext(this.map.width*this.viewport.scale,this.map.height*this.viewport.scale,(t=>{t.fillStyle=d[c].food;for(let e=0;e<u.length;e++)t.fillRect(u[e].x,u[e].y,1,1)}));i.updateBuffer(),this.renderFns.push(i.drawFromBuffer),this.updateFns=[],this.updateFns.push((()=>{switch(p.shift()){case-1:l-=90;break;case 1:l+=90}const t=f.snake.body.pop();t.x=this.snake.body[0].x-1*n(l),t.y=this.snake.body[0].y-1*s(l),this.snake.body.unshift(t)})),this.updateFns.push(e.updateBuffer),this.updateFns.push((()=>{1===this.map.data[this.snake.body[0].y*this.map.width+this.snake.body[0].x]&&this.reset()})),this.updateFns.push((()=>{for(let t=1;t<this.snake.body.length;t++)if(this.snake.body[0].x===this.snake.body[t].x&&this.snake.body[0].y===this.snake.body[t].y){this.reset();break}})),this.updateFns.push((()=>{for(let t=0;t<u.length;t++)if(void 0!==u[t]&&this.snake.body[0].x===u[t].x&&this.snake.body[0].y===u[t].y){this.snake.body.push(u.splice(t,1)[0]),this.score.update(this.score.value+1),i.updateBuffer();break}}));const a=(o=this.map,{getPoint(t){const e=function(t){let e=[...o.data];return t.body.forEach((t=>e[t.x+t.y*o.width]=1)),e.map(((t,e)=>({value:t,x:e%o.width,y:~~(e/o.width)}))).filter((t=>0===t.value))}(t);return e[~~(Math.random()*e.length)]}});var o;this.updateFns.push((()=>{if(!u.length){const t=a.getPoint(this.snake);if("object"!=typeof t)return;u.push(t),i.updateBuffer()}}))}render(){this.viewport.clear(d[c].void),this.renderFns.forEach(w)}update(){this.updateFns.forEach(w)}run(){let t=performance.now();const e=()=>{window.requestAnimationFrame(e);const s=performance.now();250<s-t&&(this.update(),t=s),this.render()};e()}};var m;window.addEventListener("load",(()=>{f.viewport.moveTo(f.snake.body[0].x*f.viewport.scale,f.snake.body[0].y*f.viewport.scale),f.render(),new Promise((t=>{const e=document.createElement("div");function s(){e.parentElement&&e.parentElement.removeChild(e),t(),f.run()}e.id="instructions",e.innerHTML="Tap to start",document.body.appendChild(e),window.addEventListener("keydown",s,{once:!0}),window.addEventListener("touchstart",s,{once:!0})})).then((()=>{["left","right"].map((t=>{const e=document.createElement("section");return e.id=t,e})).forEach((t=>{document.body.appendChild(t)}));const t=document.createElement("div");function e(){t.parentElement&&t.parentElement.removeChild(t)}t.id="instructions",t.innerHTML="<span>Tap to change direction</span>",document.body.appendChild(t),window.addEventListener("keydown",e,{once:!0}),window.addEventListener("touchstart",e,{once:!0})}))}),{once:!0}),window.addEventListener("keydown",(t=>{switch(t.key){case"ArrowLeft":f.viewport.angle+=90,f.viewport._angle-=90,p.push(-1);break;case"ArrowRight":f.viewport.angle-=90,f.viewport._angle+=90,p.push(1)}})),window.addEventListener("touchstart",(t=>{switch(t.target.id){case"left":f.viewport.angle+=90,f.viewport._angle-=90,p.push(-1);break;case"right":f.viewport.angle-=90,f.viewport._angle+=90,p.push(1)}t.target.classList.contains("clicked")||(t.target.classList.add("clicked"),setTimeout((()=>{t.target.classList.remove("clicked")}),100))})),window.addEventListener("resize",(()=>{f.viewport.resize(document.documentElement.clientWidth,document.documentElement.clientHeight),f.render()})),["gesturestart","gesturechange","gestureend","touchstart","touchchange","touchend","touchtouchcancel"].map((t=>window.addEventListener(t,(t=>t.preventDefault())))),"#stats"===window.location.hash&&((m=document.createElement("script")).onload=function(){var t=new Stats;document.body.appendChild(t.dom),requestAnimationFrame((function e(){t.update(),requestAnimationFrame(e)}))},m.src="//mrdoob.github.io/stats.js/build/stats.min.js",document.head.appendChild(m))})();