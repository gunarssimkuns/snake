(()=>{"use strict";function e(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,o=[],a=!0,s=!1;try{for(n=n.call(e);!(a=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);a=!0);}catch(e){s=!0,i=e}finally{try{a||null==n.return||n.return()}finally{if(s)throw i}}return o}}(e,n)||t(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function t(e,t){if(e){if("string"==typeof e)return n(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(e,t):void 0}}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return e*Math.PI/180}var i=Array.from({length:8}).map((function(e,t){var n=90*t-360;return[n,Math.round(Math.sin(r(n)))]})).reduce((function(t,n){var r=e(n,2),i=r[0],o=r[1];return t[i]=o,t}),{});function o(e){return i[e%360]}var a=Array.from({length:8}).map((function(e,t){var n=90*t-360;return[n,Math.round(Math.cos(r(n)))]})).reduce((function(t,n){var r=e(n,2),i=r[0],o=r[1];return t[i]=o,t}),{});function s(e){return a[e%360]}function u(e){return{getPoint:function(r){var i=function(r){var i,o=function(e){if(Array.isArray(e))return n(e)}(i=e.data)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(i)||t(i)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}();return r.body.forEach((function(t){return o[t.x+t.y*e.width]=1})),o.map((function(t,n){return{value:t,x:n%e.width,y:~~(n/e.width)}})).filter((function(e){return 0===e.value}))}(r);return i[~~(Math.random()*i.length)]}}}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.body=[]}var t,n;return t=e,n=[{key:"generate",value:function(e){var t=e.length,n=e.direction,r=void 0===n?0:n,i=e.head,a=void 0===i?{x:0,y:0}:i;return Array.from({length:t}).map((function(e,t){return{x:a.x+t*s(r),y:a.y+t*o(r)}}))}}],null&&c(t.prototype,null),n&&c(t,n),e}();function h(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var d=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:24,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:24;h(this,e),this.width=t,this.height=n,this.data=Array.from({length:t*n}).map((function(e,r){return r%t==0||r%t==t-1||0==~~(r/t)||~~(r/t)==n-1?1:0})),this.info={0:"ground",1:"wall"}};function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.el=document.createElement("span"),this.el.classList.toggle("score",!0),document.body.appendChild(this.el),this.reset()}var t,n;return t=e,(n=[{key:"update",value:function(e){this.value=e,this.el.innerHTML=this.value}},{key:"reset",value:function(){this.update(0)}}])&&f(t.prototype,n),e}();function v(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var y=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var n=t.width,r=t.height,i=t.x,o=void 0===i?0:i,a=t.y,s=void 0===a?0:a,u=t.scale,c=void 0===u?32:u;this.x=o,this.y=s,this.scale=c,this.el=document.createElement("canvas"),this.context=this.el.getContext("2d"),this._angle=0,this.angle=0,this.resize(n,r)}var t,n;return t=e,(n=[{key:"resize",value:function(e,t){this.width=e,this.height=t,this.el.width=e,this.el.height=t,this.diagonal=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return Math.floor(Math.sqrt(Math.pow(e,2)+Math.pow(t,2)))}(e,t)}},{key:"moveTo",value:function(e,t){this.x=e,this.y=t}},{key:"scrollTo",value:function(e,t){this.x+=.05*(e-this.x),this.y+=.05*(t-this.y)}},{key:"clear",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"rgba(0, 0, 0, 0)",t=this.context;t.imageSmoothingEnabled=!1,t.save(),t.fillStyle=e,t.fillRect(0,0,this.width,this.height),t.restore()}},{key:"createBufferContext",value:function(e,t,n){var i=this,o=document.createElement("canvas");o.width=e,o.height=t;var a=o.getContext("2d");return{updateBuffer:function(){a.save(),a.clearRect(0,0,o.width,o.height),a.scale(i.scale,i.scale),n(a),a.restore()},drawFromBuffer:function(){var e=i.context;e.save(),e.translate(~~(.5*i.width),~~(.5*i.height)),e.rotate(r(i.angle+i._angle)),e.translate(~~(-i.x-.5*i.scale),~~(-i.y-.5*i.scale)),e.drawImage(o,0,0,o.width,o.height),e.restore()}}}}])&&v(t.prototype,n),e}();const w=[{void:"#1f306e",ground:"#553772",wall:"#8f3b76",snake:"#c7417b",food:"#f5487f"},{void:"#343090",ground:"#5f59f7",wall:"#8c61ff",snake:"#6592fd",food:"#44c2fd"},{void:"#e74645",ground:"#fb7756",wall:"#1ac0c6",snake:"#facd60",food:"#fdfa66"},{void:"#E3D26F",ground:"#CA895F",wall:"#A15E49",snake:"#4E3822",food:"#2F1B25"}];function m(e){return(m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function g(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var b,k,E=[{x:12,y:4}],x=[],F=function(e){return e()},C=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.score=new p,this.snake=new l,this.map=new d,this.viewport=new y({width:document.documentElement.clientWidth,height:document.documentElement.clientHeight,scale:document.documentElement.clientWidth<768?24:32}),this.init()}var t,n;return t=e,(n=[{key:"reset",value:function(){b=Math.floor(Math.random()*w.length),k=90,x=[],this.viewport._angle=this.viewport.angle,this.viewport.angle=0,this.snake.body=l.generate({length:5,direction:k,head:{x:~~(.5*this.map.width),y:~~(.5*this.map.height)}}),this.score.reset()}},{key:"init",value:function(){var e=this;document.body.appendChild(this.viewport.el),this.reset(),this.renderFns=[],this.renderFns.push((function(){e.viewport.scrollTo(e.snake.body[0].x*e.viewport.scale,e.snake.body[0].y*e.viewport.scale),e.viewport._angle=e.viewport._angle-.1*e.viewport._angle}));var t=this.viewport.createBufferContext(this.map.width*this.viewport.scale,this.map.height*this.viewport.scale,(function(t){e.map.data.forEach((function(n,r){var i=e.map.info[n];t.fillStyle=w[b][i],t.fillRect(r%e.map.width,~~(r/e.map.width),1,1)}))}));t.updateBuffer(),this.renderFns.push(t.drawFromBuffer);var n=this.viewport.createBufferContext(this.map.width*this.viewport.scale,this.map.height*this.viewport.scale,(function(t){t.fillStyle=w[b].snake;for(var n=0;n<e.snake.body.length;n++)t.fillRect(e.snake.body[n].x,e.snake.body[n].y,1,1)}));n.updateBuffer(),this.renderFns.push(n.drawFromBuffer);var r=this.viewport.createBufferContext(this.map.width*this.viewport.scale,this.map.height*this.viewport.scale,(function(e){e.fillStyle=w[b].food;for(var t=0;t<E.length;t++)e.fillRect(E[t].x,E[t].y,1,1)}));r.updateBuffer(),this.renderFns.push(r.drawFromBuffer),this.updateFns=[],this.updateFns.push((function(){switch(x.shift()){case-1:k-=90;break;case 1:k+=90}var t=C.snake.body.pop();t.x=e.snake.body[0].x-1*s(k),t.y=e.snake.body[0].y-1*o(k),e.snake.body.unshift(t)})),this.updateFns.push(n.updateBuffer),this.updateFns.push((function(){1===e.map.data[e.snake.body[0].y*e.map.width+e.snake.body[0].x]&&e.reset()})),this.updateFns.push((function(){for(var t=1;t<e.snake.body.length;t++)if(e.snake.body[0].x===e.snake.body[t].x&&e.snake.body[0].y===e.snake.body[t].y){e.reset();break}})),this.updateFns.push((function(){for(var t=0;t<E.length;t++)if(void 0!==E[t]&&e.snake.body[0].x===E[t].x&&e.snake.body[0].y===E[t].y){e.snake.body.push(E.splice(t,1)[0]),e.score.update(e.score.value+1),r.updateBuffer();break}}));var i=u(this.map);this.updateFns.push((function(){if(!E.length){var t=i.getPoint(e.snake);if("object"!==m(t))return;E.push(t),r.updateBuffer()}}))}},{key:"render",value:function(){this.viewport.clear(w[b].void),this.renderFns.forEach(F)}},{key:"update",value:function(){this.updateFns.forEach(F)}},{key:"run",value:function(){var e=this,t=performance.now();!function n(){window.requestAnimationFrame(n);var r=performance.now();250<r-t&&(e.update(),t=r),e.render()}()}}])&&g(t.prototype,n),e}());window.addEventListener("load",(function(){C.viewport.moveTo(C.snake.body[0].x*C.viewport.scale,C.snake.body[0].y*C.viewport.scale),C.render(),new Promise((function(e){var t=document.createElement("div");function n(){t.parentElement&&t.parentElement.removeChild(t),e(),C.run()}t.id="instructions",t.innerHTML="Tap to start",document.body.appendChild(t),window.addEventListener("keydown",n,{once:!0}),window.addEventListener("touchstart",n,{once:!0})})).then((function(){["left","right"].map((function(e){var t=document.createElement("section");return t.id=e,t})).forEach((function(e){document.body.appendChild(e)}));var e=document.createElement("div");function t(){e.parentElement&&e.parentElement.removeChild(e)}e.id="instructions",e.innerHTML="<span>Tap to change direction</span>",document.body.appendChild(e),window.addEventListener("keydown",t,{once:!0}),window.addEventListener("touchstart",t,{once:!0})}))}),{once:!0}),window.addEventListener("keydown",(function(e){switch(e.key){case"ArrowLeft":C.viewport.angle+=90,C.viewport._angle-=90,x.push(-1);break;case"ArrowRight":C.viewport.angle-=90,C.viewport._angle+=90,x.push(1)}})),window.addEventListener("touchstart",(function(e){switch(e.target.id){case"left":C.viewport.angle+=90,C.viewport._angle-=90,x.push(-1);break;case"right":C.viewport.angle-=90,C.viewport._angle+=90,x.push(1)}e.target.classList.contains("clicked")||(e.target.classList.add("clicked"),setTimeout((function(){e.target.classList.remove("clicked")}),100))})),window.addEventListener("resize",(function(){C.viewport.resize(document.documentElement.clientWidth,document.documentElement.clientHeight),C.render()})),["gesturestart","gesturechange","gestureend","touchstart","touchchange","touchend","touchtouchcancel"].map((function(e){return window.addEventListener(e,(function(e){return e.preventDefault()}))}))})();